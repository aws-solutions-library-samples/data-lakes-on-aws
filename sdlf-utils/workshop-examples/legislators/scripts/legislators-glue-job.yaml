AWSTemplateFormatVersion: 2010-09-09
Description: Glue Job Sample

Parameters:
  pTeamName:
    Type: String
    Description: Team name for resource naming
    AllowedPattern: "[a-z0-9]{2,12}"
    ConstraintDescription: Must be between 2 and 12 characters, lowercase letters and numbers only
  pDatasetName:
    Type: String
    Description: Dataset name for resource naming
    AllowedPattern: "[a-z0-9]{2,12}"
    ConstraintDescription: Must be between 2 and 12 characters, lowercase letters and numbers only
  pPipelineDeploymentInstance:
    Type: String
    Description: specific pipeline stage deployment instance this job is for
    Default: mainB
  pArtifactsBucket:
    Description: S3 bucket used to store artifacts (from CICD or generated by data pipelines)
    Type: AWS::SSM::Parameter::Value<String>
    Default: /SDLF2/S3/ArtifactsBucket
  pEnableVpc:
    Description: Deploy SDLF resources in a VPC
    Type: AWS::SSM::Parameter::Value<String>
    Default: /SDLF/VPC/Enabled

Conditions:
  RunInVpc: !Equals [!Ref pEnableVpc, true]

Resources:
  rGlueRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub sdlf-${pTeamName}-${pDatasetName}-glue-role
      Path: /service-role/
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - glue.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - !Sub arn:${AWS::Partition}:iam::aws:policy/service-role/AWSGlueServiceRole
        - !Sub arn:${AWS::Partition}:iam::aws:policy/AmazonS3FullAccess
        - !Sub arn:${AWS::Partition}:iam::aws:policy/CloudWatchLogsFullAccess
      Policies:
        - PolicyName: !Sub sdlf-${pTeamName}-${pDatasetName}-glue-policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - kms:CreateGrant
                  - kms:Decrypt
                  - kms:DescribeKey
                  - kms:Encrypt
                  - kms:GenerateDataKey*
                  - kms:ReEncrypt*
                Resource:
                  - !Sub "{{resolve:ssm:/SDLF/KMS/${pTeamName}/InfraKeyId:1}}"
                  - !Sub "{{resolve:ssm:/SDLF/KMS/${pTeamName}/DataKeyId:1}}"
                  - !Sub "{{resolve:ssm:/SDLF2/KMS/KeyArn:1}}"

  rGlueJob:
    Type: AWS::Glue::Job
    Properties:
      Command:
        Name: glueetl
        PythonVersion: "3"
        ScriptLocation: !Sub s3://${pArtifactsBucket}/artifacts/legislators-glue-job.py
      DefaultArguments: !If
        - RunInVpc
        -
          "--job-bookmark-option": job-bookmark-enable
          "--enable-metrics": ""
          "--disable-proxy-v2": "true"
        -
          "--job-bookmark-option": job-bookmark-enable
          "--enable-metrics": ""
      ExecutionProperty:
        MaxConcurrentRuns: 3
      MaxRetries: 0
      MaxCapacity: 2.0
      GlueVersion: "4.0"
      Name: !Sub sdlf-${pTeamName}-${pDatasetName}-glue-job
      SecurityConfiguration: !Sub "{{resolve:ssm:/SDLF/Glue/${pTeamName}/SecurityConfigurationId:1}}"
      Role: !Ref rGlueRole

Outputs:
  oGlueJobName:
    Description: Name of the Glue job
    Value: !Ref rGlueJob
    Export:
      Name: !Sub ${AWS::StackName}-glue-job-name
  
  oGlueRoleArn:
    Description: ARN of the Glue job role
    Value: !GetAtt rGlueRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-glue-role-arn
