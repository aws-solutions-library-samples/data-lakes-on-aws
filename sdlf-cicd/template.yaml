AWSTemplateFormatVersion: "2010-09-09"
Description: CICD pipeline to build a CloudFormation module out of a Stage repository

Parameters:
  pSharedDevOpsAccountId:
    Type: String
    Default: "{{resolve:ssm:/SDLF/Misc/DevOpsAccountId}}"
  pDomain:
    Type: String
    Default: "{{resolve:ssm:/SDLF/Misc/pDomain}}"
  pEnvironment:
    Type: String
    Default: "{{resolve:ssm:/SDLF/Misc/pEnv}}"
  pStageRepository:
    Type: String
  pStageName:
    Description: Name of the stage (letters, numbers and hyphen allowed, no other symbols or spaces)
    Type: String
    AllowedPattern: "[a-zA-Z0-9\\-]{1,12}"
    ConstraintDescription: "letters (uppercase and lowercase), numbers and hyphen allowed - 12 characters maximum"
  pTeamName:
    Type: String
  pSharedDevOpsAccountKmsKeyArn:
    Description: Arn of the KMS key in the Shared DevOps account
    Type: String
  pArtifactsBucket:
    Description: The artifactory bucket used by CodeBuild and CodePipeline
    Type: String
    Default: "{{resolve:ssm:/SDLF/S3/CFNBucket}}"
  pEventBridgeRepositoryTriggerRoleArn:
    Type: String
    Default: "{{resolve:ssm:/SDLF/IAM/EventBridgeRepositoryTriggerRoleArn}}"

Mappings:
  pCodeCommitBranch:
    dev:
      branch: dev
    test:
      branch: test
    prod:
      branch: main

Resources:
  rStageStateMachinePipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn: "{{resolve:ssm:/SDLF/CodeBuild/CodePipelineRole}}"
      Stages:
        -
          Name: Source
          Actions:
            -
              Name: Source
              RoleArn: !Sub arn:${AWS::Partition}:iam::${pSharedDevOpsAccountId}:role/sdlf-cicd-module-codecommit-${pDomain}-${pEnvironment}
              ActionTypeId:
                Category: Source
                Owner: AWS
                Version: '1'
                Provider: CodeCommit
              OutputArtifacts:
                - Name: SourceArtifact
              Configuration:
                RepositoryName: !Ref pStageRepository
                BranchName: !FindInMap [pCodeCommitBranch, !Ref pEnvironment, branch]
                PollForSourceChanges: false
              RunOrder: 1
        -
          Name: Build
          Actions:
            -
              Name: Build
              InputArtifacts:
              - Name: SourceArtifact
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: '1'
                Provider: CodeBuild
              OutputArtifacts:
                - Name: BuildArtifact
              Configuration:
                ProjectName: "{{resolve:ssm:/SDLF/CodeBuild/BuildCloudformationModuleStage}}"
                EnvironmentVariables: !Sub >-
                  [{"name":"DOMAIN_NAME", "value":"${pDomain}", "type":"PLAINTEXT"},
                   {"name":"TEAM_NAME", "value":"${pTeamName}", "type":"PLAINTEXT"},
                   {"name":"MODULE_NAME", "value":"${pStageName}", "type":"PLAINTEXT"}]
              RunOrder: 1
      ArtifactStore:
        Type: S3
        EncryptionKey:
          Id: !Ref pSharedDevOpsAccountKmsKeyArn
          Type: KMS
        Location: !Ref pArtifactsBucket

  rStageStateMachineTriggerEventRule:
    Type: AWS::Events::Rule
    Properties:
      Description: !Sub "Run Stage State Machine on ${pStageName} repository update"
      EventPattern:
        source:
          - aws.codecommit
        detail-type:
          - CodeCommit Repository State Change
        resources:
          - !Sub arn:${AWS::Partition}:codecommit:${AWS::Region}:${pSharedDevOpsAccountId}:${pStageRepository}
        detail:
          event:
            - referenceCreated
            - referenceUpdated
          referenceType:
            - branch
          referenceName:
            - dev
            - test
            - main
      Targets:
        - Arn: !Sub arn:${AWS::Partition}:codepipeline:${AWS::Region}:${AWS::AccountId}:${rStageStateMachinePipeline}
          Id: !Sub sdlf-${pStageRepository}-trigger
          RoleArn: !Ref pEventBridgeRepositoryTriggerRoleArn
